---
const { caption, cssClass, index, site, src, total } = Astro.props

// A random string with the syntax '[a-z][0-9]{3}-index-total'
const key = Math.random().toString(36).slice(2, 6) + '-' + index + '/' + total

// Internal links (project pages) open in same tab; external open in new tab
const isInternal = site.startsWith('/')

// Accent colors per project
const colorMap: Record<string, { bg: string; accent: string }> = {
  '/work/gochain':            { bg: '#071a0f', accent: '#4ade80' },
  '/work/private-clinic':    { bg: '#0e0a18', accent: '#a78bfa' },
  '/work/ams-device':        { bg: '#080f1a', accent: '#60a5fa' },
  '/work/engineering-rocket':{ bg: '#180a06', accent: '#fb923c' },
  '/work/portfolio-rocket':  { bg: '#0d0d0d', accent: '#f5f5f5' },
}
const palette = colorMap[site] ?? { bg: '#111', accent: '#fff' }
---

<a-work class={cssClass}>
  <!-- Hidden video kept for SWork.js compatibility -->
  <video
    data-src={src}
    class="a__video js-video"
    loop
    muted
    playsinline
    width="1082"
    height="636"
    style="display:none"
  ></video>

  <div class="a__inner">
    <a href={site} target={isInternal ? '_self' : '_blank'} rel={isInternal ? undefined : 'noopener noreferrer'}>
      <!-- Styled project card -->
      <div class="a__card" style={`background:${palette.bg};`}>
        <div class="a__card__index" style={`color:${palette.accent};`}>{index}</div>
        <div class="a__card__title" style={`color:#fff;`}>{caption}</div>
        <div class="a__card__cta" style={`color:${palette.accent};`}>View project â†’</div>
        <div class="a__card__grid"></div>
      </div>

      <div class="a__caption">
        <div class="a__caption__text">{caption}</div>
        <div class="a__caption__key">#{key}</div>
      </div>
    </a>
  </div><!-- .a__inner -->
</a-work>

<script>
  class AWork extends HTMLElement {
    static observedAttributes = ['progress']

    link: HTMLAnchorElement
    video: HTMLVideoElement

    isPlaying: boolean

    /**
     * Init
     */
    connectedCallback() {
      // Elements
      this.video = this.querySelector('.js-video')
      this.link = this.querySelector('a')

      // Properties
      this.isPlaying = false

      // Events
      this.link.addEventListener('click', this.onClick.bind(this))
    }

    /**
     * Attribute changed
     */
    attributeChangedCallback(name, oldValue, newValue) {
      if (name === 'progress') {
        this.style.setProperty('--progress', newValue)

        if (newValue === '1' || newValue === '-1') {
          if (this.isPlaying) {
            this.outView()
          }
        } else {
          if (!this.isPlaying) {
            this.inView()
          }
        }
      }
    }

    /**
     * Gets in view
     */
    inView() {
      if (this.video) this.video.play()
      this.isPlaying = true
      this.classList.add('is-inview')
    }

    /**
     * Gets out view
     */
    outView() {
      if (this.video) this.video.pause()
      this.isPlaying = false
      this.classList.remove('is-inview')
    }

    /**
     * On click
     */
    onClick(event: MouseEvent) {
      if (this.link.href.includes('#')) {
        event.preventDefault()
        return false
      }
    }
  }

  customElements.define('a-work', AWork)
</script>

<style lang="scss">
  a-work {
    position: relative;
    top: 0;
    left: 0;

    display: block;
    margin: 0;
    padding: 0.5rem 0.5rem 0;

    background: color(secondary);
    content-visibility: hidden;

    transform-style: preserve-3d;

    will-change: transform;

    @include mq(phone) {
      padding: 0.25rem;
    }

    a {
      display: block;

      text-decoration: none;
    }

    .a__inner {
      display: block;
      margin: 0;
      padding: 0;
    }

    .a__card {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow: hidden;

      width: auto;
      max-width: 50vw;
      height: auto;
      max-height: 50vh;
      min-width: 280px;
      min-height: 180px;
      aspect-ratio: 16 / 10;

      padding: 1.25rem 1.5rem;
      box-sizing: border-box;
      border: 1px solid rgba(255, 255, 255, 0.08);

      @include mq(phone) {
        max-width: 80vw;
        max-height: 80vh;
        min-width: 200px;
        min-height: 130px;
      }
    }

    /* Subtle dot-grid background texture */
    .a__card__grid {
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle, rgba(255,255,255,0.06) 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
    }

    .a__card__index {
      font: 700 11px / 1 font-family(fraktion);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      opacity: 0.7;
      position: relative;
      z-index: 1;
    }

    .a__card__title {
      font: 700 clamp(1.25rem, 3.5vw, 2.5rem) / 1.1 font-family(editorial);
      text-transform: uppercase;
      letter-spacing: -0.02em;
      position: relative;
      z-index: 1;
    }

    .a__card__cta {
      font: 700 11px / 1 font-family(fraktion);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      position: relative;
      z-index: 1;
    }

    .a__video {
      display: none !important;
    }

    .a__caption {
      @include flex(row, center, space-between);

      padding: 0.5rem 0.5rem;

      color: color(primary);
      font: 700 11px / 1 font-family(fraktion);
      letter-spacing: 0.15em;
      text-align: right;
      text-transform: uppercase;

      @include mq(phone) {
        display: none;
      }
    }

    &.is-inview {
      content-visibility: visible;
    }
  }
</style>
